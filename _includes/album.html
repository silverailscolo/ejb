<div id="{{ include.albumname }}">
  <!-- div autogenerated from folder include.albumname of imgs, based on Jimmy Xiao -->
  <!-- uses _plugins/Jekyll-ExifTag.rb and exiftool gem -->
  <!-- only works in primary/non-polyglot language - fixed by using static_href, requires Polyglot 1.4 -->
  <!-- polyglot gem returns static_files empty unless default language or not exclude-from-localization. -->
  <!-- Don't wish redundant asset copies, but it is OK to delete all assets/img files except in _site. -->
  <!-- Delete action added to post-build script -->

  {% for image in site.static_files %} {% assign ip = image.path %} {% if ip contains 'img' and ip contains include.albumname %} {% unless
  image.extname == '.webp' or image.extname == '.xmp' %} {% if include.albumname contains 'covers' %} {% comment %} *covers is for
  books/records/enginepics etc stored as folders with same name as img.name, no lightGallery support used in front matter, links directly to item page
  index.html in subfolder of img name base {% endcomment %}
  <a href="{{ image.name | replace: '.jpg', '/' | replace: '.png', '/'}}" class="image-ref">
    <img
      src="{{ site.baseurl }}/assets/thumbnails{{ ip | replace: 'assets/img-noresample/', ''| replace: 'assets/img/', ''}}"
      alt="{{ image.name }}"
      title="{% exiftag image_description, , {{ ip }} %}"
    />
  </a>
  {% else %} {% comment %} Valid exiftag.exiftool tags: EXIF: image_description; IPTC: headline, caption-abstract; XMP: Description, Comment; used in
  all sets: copyright (case-insensitive). Advanced trickle down: caption-cascade and copyright-cascade {% endcomment %}
  <a
    {%
    static_href
    %}href="{{ site.baseurl }}{{ ip }}"
    {%
    endstatic_href
    %}
    class="image-ref"
    data-sub-html="{% exiftag caption-cascade, , {{ ip }} %} {% exiftag copyright-cascade, , {{ ip }} %}"
    date="{% exiftag datetime, , {{ ip }} %}"
  >
    <img
      src="{{ site.baseurl }}/assets/thumbnails{{ ip | replace: 'assets/img-noresample/', ''| replace: 'assets/img/', ''}}"
      alt="{% exiftag image_description, , {{ ip }} %}"
    />
  </a>
  {% comment %}Exif tags contain non UTF-8 encoding. Encoding is enforced in exiftag.rb plugin.{% endcomment %}
  {% endif %} {% endunless %} {% endif %} {% endfor %}
</div>

<script>
  window.addEventListener("DOMContentLoaded", () => {
    lightGallery(document.getElementById("{{ include.albumname }}"), {
      plugins: [lgZoom, lgThumbnail, lgAutoplay],
      closable: true,
      selector: ".image-ref",
      slideDelay: 100,
      speed: 500,
      thumbnails: true,
      thumbWidth: 60,
      thumbHeight: "40px",
      thumbMargin: 4,
      mobileSettings: {
        controls: false,
        showCloseIcon: true,
        download: false,
        rotate: false,
        thumbnail: false,
      },
      getSortData: {
        byDate : function ( $elem ) {
          dtStr = $elem.find('[date]').text();
          // attr date="2024:09:08 11:50:43"
          dtArray = dtStr.split(' '), d = dtArray[0], t = dArray[1];
          dArray = d.split(':'), year = dateArray[0], month = dateArray[1], day = dateArray[0];
          tArray = t.split(':'), hour = tArray[0], mins = tArray[1], secs = tArray[2];
          // d = DateTime.new(year, month, day, hour, mins, secs, offset);
          // Create a date in a time zone (AMS)
          d = DateTime.new(year,month,day, hour,mins,secs, "+01:00"); // Rational(+1, 24));
          jDate = new Date(d);
          ts = jDate.getTime();
          return ts;
        }
      },
    });

    // init isotope
    var $grid = $("#{{ include.albumname }}");
    $grid.isotope({
      percentPosition: true,
      itemSelector: ".image-ref",
      layoutMode: "masonry",
      gutter: 5,
      sortBy: 'byDate',
      sortAscending: false,
    });

    // layout Isotope after each image loads
    $grid.imagesLoaded().progress(function () {
      $grid.masonry();
    });
  });
</script>
